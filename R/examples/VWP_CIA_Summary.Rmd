---
date: "`r format(Sys.time(), '%m/%d/%Y')`"
author: ""
title: "VWP CIA Summary - [INSERT PROJECT NAME HERE]"
output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
    page_margins:
      bottom: 0.5
      top: 0.5
      right: 1
      left: 0.5
      header: 0.0
      footer: 0.0
params: 
  rseg.hydroid: 462757 # Ex: Crooked Run = 476998, SF Powell below BSG = 477140, SF Powell at dam: 462757
  fac.hydroid: 72672 # Ex: Blue Ridge Shadows = 71977, BIG STONE GAP WTP = 72672: "runid_6014"
  runid.list: [ "runid_6011","runid_6013" ]
  fac.metric.list: [ "wd_mgd","ps_mgd","unmet30_mgd" ]
  rseg.metric.list: [ "Qout","remaining_days_p0","l30_Qout",
    "l90_Qout","consumptive_use_frac","wd_cumulative_mgd","ps_cumulative_mgd" ]
  intake_stats_runid: 11
  intake_stats_varname: "Qintake"
---

```{r setup, include=FALSE}
#"runid_201","runid_401","runid_6014","runid_6011","runid_6013","runid_6015","runid_6012"
#https://cran.r-project.org/web/packages/officedown/officedown.pdf
#https://ardata-fr.github.io/officeverse/officedown-for-word.html#insert-sections
knitr::opts_chunk$set(echo = TRUE, fig.cap = TRUE)
library(officedown)
library(officer)
library(flextable)
library(hydrotools)
library(rjson)
basepath='/var/www/R'
source('/var/www/R/config.R')
#source(paste(github_location,"/hydro-tools/R/om_cia_table.R",sep="")) #Used during development
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/fn_get_prop.R") #Used during development
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/rest_functions.R") #Used during development
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/find_name.R") #Used during development
source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/R/fac_utils.R") #Used until fac_utils is packaged
# Could also use:
#source("https://raw.githubusercontent.com/HARPgroup/hydro-tools/master/VAHydro-2.0/run_text.R") #Used during development

fp <- fp_par(
  text.align = "center", 
  padding.bottom = 20, padding.top = 120, 
  border.bottom = fp_border())

ft <- fp_text(shading.color='#EFEFEF', bold = TRUE)

```


```{r UserInputs, include=FALSE}
site.plots <- omsite #image files use http

#SPECIFY MODELS AND RUNIDS OF INTEREST

rseg.hydroid <- params$rseg.hydroid
fac.hydroid <- params$fac.hydroid
runid.list <- params$runid.list
fac.metric.list <- params$fac.metric.list
rseg.metric.list <- params$rseg.metric.list
intake_stats_runid <- params$intake_stats_runid
intake_stats_varname <- params$intake_stats_varname

#runid.list <- c('runid_400','runid_600')
#runid.list <- c('runid_201','runid_401')
rlist <- gsub('runid_', '', runid.list)

# SALEM WTP
# rseg.hydroid <- 68327
# fac.hydroid <- 73112
# runid.list <- c('runid_11','runid_12','runid_13')
# 
# fac.metric.list <- c('wd_mgd','ps_mgd','unmet30_mgd')
# rseg.metric.list <- c("Qout","Qbaseline","l30_Qout","l90_Qout","consumptive_use_frac","wd_cumulative_mgd","ps_cumulative_mgd")

#RSEG MODEL INFO
print(paste("searching", site,"for river segment id", rseg.hydroid))

#base_url = site, entity_id = rseg.hydroid

rseg.model <- om_get_model(site, rseg.hydroid)
rseg.elid <- om_get_prop(site, rseg.model$pid, entity_type = 'dh_properties','om_element_connection')$propvalue

#FAC MODEL INFO
fac.model <- om_get_model(site, fac.hydroid, model_varkey = 'om_water_system_element')
fac.elid <- om_get_prop(site, fac.model$pid, entity_type = 'dh_properties','om_element_connection')$propvalue

if (exists("json_obj_url")) {
  fac_obj_url <- paste(json_obj_url, fac.model$pid, sep="/")
  fac_model_info <- om_auth_read(fac_obj_url, token,  "text/json", "")
  fac_model_info <- fromJSON(fac_model_info)
  rseg_obj_url <- paste(json_obj_url, rseg.model$pid, sep="/")
  rseg_model_info <- om_auth_read(rseg_obj_url, token,  "text/json", "")
  rseg_model_info <- fromJSON(rseg_model_info)
  # get report cusomtizations
  fac_report_info = find_name(fac_model_info, "reports")
  rseg_report_info = find_name(rseg_model_info, "reports")
} else {
  message("Error: json_obj_url is undefined.  Can not retrieve model and scenario information. (Hint: Use config.R to set json_obj_url) ")
  fac_model_info <- list()
  rseg_model_info <- list()
}

fac_default_info = list(
  model_overview = list(
    "value" = "Facility intake model overview not provided."
  ),
  intake_name = list(
    "value"  = "un-named intake"
  )
)
rseg_default_info = list(
  model_overview = list(
    "value" = "River segment model overview not provided."
  )
)

fac_report_info <- merge.list(fac_report_info, fac_default_info)
rseg_report_info <- merge.list(rseg_report_info, rseg_default_info)   

# Pre load the output runs so we have them available for later use
# I think the om_get_prop here is no longer needed, rather, we 
fac_runs = FALSE
rseg_runs = FALSE
short_names = list()
run_names = list()

for (i in 1:length(runid.list)){
  # get fac model run prop
  # get river model run prop 
  runid.i <- runid.list[i]
  run.i <- sub("runid_", "", runid.i)
  fac_run <- om_get_prop(site,fac.model$pid, "dh_properties", runid.i)
  if (is.logical(fac_runs)) {
    fac_runs <- as.data.frame(fac_run)
  } else {
    fac_runs <- rbind(fac_runs, fac_run)
  }
  rseg_run <- om_get_prop(site,rseg.model$pid, "dh_properties", runid.i)
  if (is.logical(rseg_runs)) {
    rseg_runs <- as.data.frame(rseg_run)
  } else {
    rseg_runs <- rbind(rseg_runs, rseg_run)
  }
  # TODO: prepopulate runid_XXX$report$facility_default_reports and riverseg_default_reports on the om_model_scenario variable to load as a default for these.  For example, runid11 is *always* the current WSP run, so there should be no need to give it a short name, or scenario name at the individual facility level.
  # stash short names since they are used frequently
  fac_run_info <- find_name(fac_model_info,runid.i)
  f_rep <- find_name(fac_run_info,'reports')
  # get the short name
  if (is.null(f_rep$scenario_short_name$value)) {
    short_names[[runid.i]] <- runid.i
  } else {
    short_names[[runid.i]] = as.character(f_rep$scenario_short_name$value)
  }
  # get the long name
  if (is.null(f_rep$scenario_name$value)) {
    run_names[[runid.i]] <- runid.i
  } else {
    run_names[[runid.i]] = as.character(f_rep$scenario_name$value)
  }
}


```


# VAHydro Model:


## VAHydro
The comprehensive VAHydro hydrologic model is used to evaluate potential impacts to surface water supply and other beneficial uses (including aquatic life), for withdrawal projects that have applied for a Virginia Water Protection (VWP). The VAHydro model simulates streamflow with inputs such as precipitation, climate, land use, and topography, as well as local data collected through Local and Regional Water Supply Plans and reported water use submitted to DEQ through the Annual Water Withdrawal Reporting program. The VAHydro model includes all known withdrawals and discharges, as well as operational rules of VWP permits and major hydrologic features such as reservoirs. 

The VAHydro model is built on rainfall-evaporation-runoff (RER) time-series from the Chesapeake Bay Model Phase 6 which runs from 1984-2014 in the Chesapeake Bay watershed drainage, and 1984-2005 in the rivers flowing outside of the Chesapeake Bay watershed, aka the “southern rivers.” The VAHydro model features high-resolution hydrologic subsections called “river segments” (over 600 river segments in total), roughly the size of HUC 10 hydrologic units, with additional high-resolution segments added for VWP modeling projects as needed.

## CIA
DEQ assesses water supply sustainability through Cumulative Impact Analysis (CIA) modeling. CIA is a modeling and analysis approach that takes into account the varied hydrologic process occurring throughout a river network (including meteorology and human water use). By simulating a daily water balance for every individual river segment within a watershed, DEQ is able to evaluate the potential “cumulative impact” of all streamflow changes occurring upstream and downstream of any location within the river system, as well as the downstream impact of a specific proposed or permitted surface water withdrawal.

The goal of the following analysis is to estimate the potential impacts of the proposed water withdrawal upon existing beneficial uses, including both in-stream and off-stream uses. In addition, cumulative impacts from all existing withdrawals are included in the evaluation.

### Glossary of Cumulative Impact Modeling Terms
- Consumptive Use (CU): This is calculated as a fraction of modeled Flow, so it is CU = 1.0 - (Flow / Flow_Baseline), where Flow_Baseline = (Flow + WD - PS), and WD and PS are the total cumulative withdrawals and point source discharges above the point in the stream.  In other words, for calculating baseline flow, we take modeled outflow from the river, add the withdrawals back in, and subtract the point source in order to estimate a baseline flow balance.  This almost always ends up being a higher number than the modeled Flow out, so it tells us the fraction of baseline flow that is consumed.  Occasionally there are water transfers and point sources from groundwater, or point sources that cross watershed boundaries that can make the CU fraction in some watersheds negative, i.e. Flow > Flow_Baseline. 

\newpage
# Project Introduction

This project consists of an existing water intake constructed in the 1960's with an upgrade in the early 1980's. The Town owns and operates the Big Cherry Dam located approximately 3 miles upstream from the intake structure. The Town's water treatment plant operators control the amount of water discharging the dam into the Powell River and all of the stream by-pass flow to meet the previous permit requirements of 4.0 MOD of maximum withdrawal and 0.50 MGD of by-pass flow. This is always true unless the dam is overflowing exceeding the amount of water required from various rainfall events. Therefore, the existing/proposed maximum withdrawal amounts will not have an impact on the stream in terms of rates, volumes, frequency, etc. This is a daily activity as it serves the existing water treatment plant.

Permit: Big Cherry Dam, 01-0688  
Permit Dates: 2003-08-23 to 2018-08-22  

* **Annual Withdrawal Limit** = 1168 mg/yr (3.2 mgd)
    + (historically they withdraw ~2 mgd on average)
* **Daily Withdrawal Limit** = 4 mgd 
* **Flow-by** = 0.5 mgd 
<br>
<br>
<br>

## Location Map

```{r GrabLocationMap, include=FALSE, echo=FALSE}
fig_prop <- om_get_prop(site,fac.model$pid, "dh_properties", "fig.location_map")
```

```{r LocationMap, echo=FALSE, results = "asis"}

if (!is.logical(fig_prop)) {
  map_path <- fig_prop$propcode
  cat(paste0("![](",map_path,")"),"\n")
} else {
  cat(paste0("*No location map available for this facility model*"))
}
``` 

\newpage
# Model Overview and Scenario Descriptions

```{r ModelOverview, echo=FALSE, results = "asis"}

cat("__River Model Description__\n")
cat(paste(rseg_report_info$model_overview$value,"\n\n"))
cat("__Facility & Intake Model Description__\n")
cat(paste(fac_report_info$model_overview$value,"\n\n"))
```

The following model scenarios were simulated in order to determine the most effective means of meeting the project need and all other in-stream beneficial uses:

```{r LoadRunInfo, echo=FALSE, results = "asis"}
for (i in 1:length(runid.list)){
  # get fac model run prop
  # get river model run prop 
  runid.i <- runid.list[i]
  run.i <- sub("runid_", "", runid.i)
  run_info <- find_name(fac_model_info,runid.i)
  
  if (is.null(run_info$reports)) {
    cat(paste("*", paste0("__",run_info$name,"__"),"-","Run report information not provided.","\n"))
  } else {
    ri <- run_info$reports
    cat(
      paste(
        "*", 
        paste0(
          "__",ri$scenario_name$value,"__", 
        " (", ri$scenario_short_name$value, ")"
        ),
        "-",run_info$reports$scenario_intro$value,"\n\n")
      )
  }
  
}

```

\newpage

# Intake Site Description & Current Estimated Stream Flows

```{r LoadSiteInfo, include=FALSE}
dat_current <- om_get_rundata(fac.elid, intake_stats_runid, omsite, FALSE)
# catch instances where older models did not have Qintake
# does this have an impoundment sub-comp and is imp_off = 0?
cols <- names(dat_current)
if(!(intake_stats_varname %in% cols)) {
  dat_current[,intake_stats_varname] <- dat_current$Qriver
}
intake_sum_current <- om_flow_table(dat_current, intake_stats_varname)
ex_col = "10%"
jan_ex <- intake_sum_current[1,ex_col]
if (jan_ex == 0) {
  ex_col = "25%"
}
jan_ex <- intake_sum_current[1,ex_col]
non_ex_text <- paste0("For example, in the table below the ",ex_col," column states that ",ex_col," of flows within the month of January would be less than ", jan_ex, " cfs.")
drun_info <- find_name(fac_model_info,paste0("runid_",intake_stats_runid))
demand_url <- drun_info$fig.monthly_demand$code
```

```{r SiteTable, echo=FALSE, results = "asis"}
# Format table
ft <- qflextable(intake_sum_current)
ft <- theme_box(ft)
ft <- bg(ft, bg = "#EFEFEF", part = "header")
cat(paste("__Table 1:__ Modeled monthly current flow statistics for", fac_report_info$intake_name$value, "in cubic feet per second (cfs). Columns show the minimum (Min) and average (Mean) modeled flow, and a range of non-exceedance flow percentiles, that is, the column header indicates the percent of flows that do *not* exceed the given value. For example, the", paste0("\"",ex_col, "\""), "states that only", ex_col, "of flows in the given month are expected to be less than the indicated value, and therefore, 90% of the flows in that month are expected to be greater than the given value.", non_ex_text) )
ft
if (!is.null(demand_url)) {
    cat("\n\n## Facility Base Demand Before Conservation: ", short_names[[runid.i]],"\n\n")
    cat(paste0("![](",demand_url,")"),"\n")
    cat("\n\n\\pagebreak\n")
}
```
  
\newpage
# Model Results Summary

Four scenarios are presented below to examine the alternatives for this permit re-issuance.  A summary of how permit rules affect available water for this permit, and how this operation may impact instream beneficial uses, and other downstream water withdrawals is presented.   

```{r LoadRunResults, echo=FALSE, results = "asis"}
for (i in 1:length(runid.list)){
  # get fac model run prop
  # get river model run prop 
  runid.i <- runid.list[i]
  run.i <- sub("runid_", "", runid.i)
  run_info <- find_name(fac_model_info,runid.i)
  if (is.null(run_info$reports)) {
    cat(paste("*", paste0("__",run_names[runid.i],"__"),"-","Run analysis not provided.","\n"))
  } else {
    ri <- run_info$reports
    cat(
      paste(
        "*", 
        paste0(
          "__",ri$scenario_name$value,"__"
        ),
        "-",run_info$reports$scenario_analysis$value,"\n")
      )
  }
  
}
```

## Conclusion

Overall, remodeling to consider a net % change to flow (after the point source return flow) has improved the outlook across all scenarios examined, and supports moving towards a "percent of flow" flowby approach. When modeling as a net % change in flow, the reservoir is not chronically drawn down as was shown in previous model results.

With the current permit operations and a limit of 3.2 mgd they likely wouldn't be able to meet a 90% flowby and retain 60 days remaining storage in the reservoir during the drought of record. However a flowby closer to 80% would likely be effective at maintaining storage levels and ensuring they can sustainably meet demand during dry periods while still better preserving the natural flow regime over a static 0.5 mgd flowby approach. This project may also be able to get to a 90% flowby by reducing demands from 3.2 mgd to around 3.0 mgd, and/or by including drought triggers in the permit to help maintain storage levels in the reservoir during dry periods (this permit doesn't currently have drought triggers in place). Additionally, this facility has emergency connections with neighboring towns which may be sufficient to maintain supply during times of extreme drought. Note that demand is projected to decline according to water supply plan.

<!-- TEXT STASHED for Joey -->
<!-- * Safe yield of the intake is listed as 3.2 mgd from a study published in 2001 (3.2 mgd is equivalent to the permit annual withdrawal limit of 1168 mg/yr). -->
<!--     + The data for the study was collected in 1997, which predates the drought period of 1999-2002. -->
<!-- * Under the current scenario (withdrawing around 2 mgd/day on average based on current reported withdrawals) they are okay in terms of storage days remaining (132 days) during the drought of record. -->
<!-- * Under the current maximum permitted scenario (withdrawing up to 3.2 mgd) storage days remaining drops to 0, and the model shows they are unable to meet all demand during the drought of record. -->
<!-- * Reducing the annual withdrawal limit from 1168 mg/yr to 949 mg/yr (3.2 mgd to 2.6 mgd) would likely be sufficient to increase the storage days remaining from 0 to 64 or more days during the drought of record. -->
<!--     + Note that demand is projected to decline according to water supply plan. -->
<!--     + The max daily withdrawal limit would remain 4.0 mgd -->
<!-- * DWR standard guidance for an intake not withdrawing more than 10% instantaneous flow (90% flowby) likely wouldn't work for this project (reservoir chronically drawn down). -->
<!--     + In order to meet a 90% flowby, the annual withdrawal limit may need to be reduced from 3.2 mgd to around 0.68 mgd in order to preserve 47 days remaining storage in the reservoir during the drought of record. -->
<!-- * However a 40% flowby would likely be effective at maintaining storage levels and ensuring they can sustainably meet demand while better preserving the natural flow regime. -->
<!--     + Changing the flowby from a static 0.5 mgd to a 40% of flow approach when combined with a 2.6 mgd annual withdrawal limit results in around 29 days of storage remaining and no days in which they're unable to meet demands at the intake during the drought of record. -->
<!--     + Although the 40% flowby we tested results in fewer than 60 days remaining storage, emergency connections with neighboring towns would likely be sufficient to maintain supply during times of extreme drought. Additionally, this permit doesn't currently have drought triggers in place which could help maintain storage levels during dry periods. -->
<!--     + Provided that conservation measures can be formulated that permit 60 days remaining storage, the 40% flowby would result in the same 2.6 mgd safe yield as the current 0.5 mgd flowby. -->

\newpage



```{r LoadStatsTable, include=FALSE}
# todo: pass in fac_model_info and rseg_model_info to:
#       - eliminate redundant data retrieval, since all data that is pulled inside om_cia_table via om_vahydro_metric_grid is already inside fac_model_info and rseg_model_info data structures
#       - eliminate having data retrieval and data formatting/analysis in the same function (best practice)
# this could now, I think, be simplified as:
# om_cia_table(fac_model_info, rseg_model_info)
statsdf <- om_cia_table(
  fac_model_info = fac_model_info,
  rseg_model_info = rseg_model_info,
  runid.list = runid.list, 
  fac.metric.list = fac.metric.list,
  rseg.metric.list = rseg.metric.list,
  site,
  omsite
)

statsdf <- cbind(rownames(statsdf),statsdf)
names(statsdf)[names(statsdf) == 'rownames(statsdf)'] <- 'Desc'
 
statsdf_sql <- paste('SELECT
                  CASE
                    WHEN "Desc" = "Rseg_Stats" THEN "River Segment Model Statistics:"
                    WHEN "Desc" = "Qout" THEN "Flow Out (cfs)"
                    WHEN "Desc" = "Qbaseline" THEN "Flow Baseline (cfs)"
                    WHEN "Desc" = "remaining_days_p0" THEN "Minimum Days of Storage Remaining"
                    WHEN "Desc" = "l30_Qout" THEN "30 Day Low Flow (cfs)"
                    WHEN "Desc" = "l90_Qout" THEN "90 Day Low Flow (cfs)"
                    WHEN "Desc" = "consumptive_use_frac" THEN "Consumptive Use Fraction"
                    WHEN "Desc" = "wd_cumulative_mgd" THEN "Cumulative Withdrawal (mgd)"
                    WHEN "Desc" = "ps_cumulative_mgd" THEN "Cumulative Point Source (mgd)" 
                    WHEN "Desc" = "Facility_Stats" THEN "Facility Model Statistics:"
                    WHEN "Desc" = "wd_mgd" THEN "Withdrawal (mgd)"  
                    WHEN "Desc" = "ps_mgd" THEN "Point Source (mgd)"  
                    WHEN "Desc" = "unmet30_mgd" THEN "Maximum 30 day potential unmet demand (mgd)"
                    WHEN "Desc" = "richness_change_abs" THEN "Richness Change (abs)"
                    WHEN "Desc" = "richness_change_pct" THEN "Richness Change (%)"
                    WHEN "Desc" = "rseg_model" THEN "Name"
                    WHEN "Desc" = "fac_model" THEN "Name"
                    ELSE Desc
                  END AS Description, *
                 FROM statsdf
                 WHERE Desc NOT IN ("riverseg","run_date","starttime","endtime")
                 ',sep='')
statsdf <- sqldf(statsdf_sql)
statsdf <- statsdf[,-2]
```
# Cumulative Impact Analysis
This table summarizes the cumulative impacts to flows, aquatic life, and off-stream demand for the project.  The section entitled "River Segment Model Statistics" contains mean flows (Flow Out), and drought flows (30 and 90 Day Low Flow), as well as an estimated percent total consumptive use as a result of all withdrawals (Cumulative Withdrawal) and discharges (Cumulative Point Source) in the watershed.  Minimum Days of Storage Remaining describes the number of days of remaining storage available during the driest period of the model simulation (applicable to impoundment models only). Estimates for richness change are also presented both as an absolute number of species (Richness Change (abs)) and as a percentage of the total number of species present (Richness Change (%)). Richness change calcualtions are derived from the estimated percent total consumptive use (For additional details on "elfgen" methodology, see https://onlinelibrary.wiley.com/doi/full/10.1111/1752-1688.12876).  The section entitled "Facility Model Statistics" shows the withdrawals, return flows (Point Source), and the model estimate for potential unmet demand due to demands exceeding the allowable withdrawal at the intake based on the cumulative conditions in the watershed and the flow-by rules in effect.  There will be one or more columns in this table representing each scenario considered for this analysis.

<!---BLOCK_LANDSCAPE_START--->
## Stats Comparison Table:
```{r StatsTable, echo=FALSE}
ft <- qflextable(statsdf)

# Set column widths
ft <- width(ft, j = 2:length(statsdf[1,]), width = 1.9)
ft <- width(ft, j = 1, width = 2)

# Add header row -----------------------------------------------------------------------------------
# ft <- add_header_row(x = ft, values = c("", "Scenario Alternatives"),colwidths = c(3, 4))

# Set theme
ft <- theme_box(ft)

# Set background color of select rows --------------------------------------------------------------
ft <- bg(ft, bg = "#EFEFEF", part = "header")
ft <- bg(ft, i = ~ Description == "River Segment Model Statistics:", bg = "#EFEFEF", part = "body")
ft <- bg(ft, i = ~ Description == "Facility Model Statistics:", bg = "#EFEFEF", part = "body")
fontsize(ft, size = 9)
```
<!---BLOCK_LANDSCAPE_STOP--->


# Reservoir Storage Plots:
The following reservoir storage plots depict changes in reservoir storage under each scenario (indicated in black), as well as simulated inflow to the reservoir (blue), simulated outflow from the reservoir (green), and system demand for the given scenario (red).  For water supply reservoirs, a minimum of 60 days of remaining storage over the course of the simulation is recommended. System demand varies seasonally. 

```{r ResPLOTS, echo=FALSE, message=FALSE, results = "asis"}

# check river model for plots
for (i in 1:length(runid.list)){
  # get fac model run prop
  # get river model run prop 
  runid.i <- runid.list[i]
  run.i <- sub("runid_", "", runid.i)
  rseg_prop <- om_get_prop(site,rseg_runs[i,]$pid, "dh_properties", "fig.imp_storage.all")
  run_info <- find_name(fac_model_info,runid.i)
  if (!is.logical(rseg_prop)) {
    fig_path <- rseg_prop$propcode
    # we have an image, show it 
    cat("\n\n## Reservoir Storage: ", short_names[[runid.i]],"\n\n")
    cat(paste0("![](",fig_path,")"),"\n")
    cat("\n\n\\pagebreak\n")
  } else {
    # try facility and impoundment linked to river segment.
    fac_prop <- om_get_prop(site,fac_runs[i,]$pid, "dh_properties", "fig.imp_storage.all")
    print(paste("No riverseg impoundment for run id",run.i))
  }
}

``` 

\newpage

# Unmet Demand Plots:
The following heatmaps depict the number of days with unmet demands for each month of the simulation (due to demands exceeding allowable withdrawal at the intake based on the cumulative conditions in the watershed and the flow-by rules in effect). Heatmaps also show the amount of unmet demand for each month [Unmet Days / Amount (mgd)]. Hydrographs are shown for the period of the simulation with greatest unmet demand.

```{r UnmetDemandPLOTS, echo=FALSE, message=FALSE, results = "asis"}

# check facility model for plots
for (i in 1:length(runid.list)){
  # get fac model run prop
  # get river model run prop 
  runid.i <- runid.list[i]
  run.i <- sub("runid_", "", runid.i)
  # 
  fig_prop <- invisible(om_get_prop(site,fac_runs[i,]$pid, "dh_properties", "fig.unmet_heatmap_amt"))
  if (!is.logical(fig_prop)) {
    fig_path <- fig_prop$propcode
    # we have an image, show it 
    cat("\n\n## Heatmap: ",short_names[[runid.i]],"\n\n")
    cat(paste0("![](",fig_path,")"),"\n")
  }
  fig_prop <- om_get_prop(site,fac_runs[i,]$pid, "dh_properties", "fig.30daymax_unmet")
  if (!is.logical(fig_prop)) {
    fig_path <- fig_prop$propcode
    # we have an image, show it 
    cat("\n\n## Hydrograph: ",short_names[[runid.i]],"\n\n")
    cat(paste0("![](",fig_path,")"),"\n")
    #cat("\n\n\\pagebreak\n")
  }
  
}

``` 

\newpage

# Ecological Impacts Assessment:

## Elfgen:
In response to a need for better environmental flow metrics, DEQ has developed a new framework for characterizing relations between streamflow and aquatic organism species richness. Part of an evolving approach to managing environmental flows for maintaining aquatic life; this methodology builds on existing minimum instream ow approaches, allowable withdrawals as a percentage of flow, and extensive flow-habitat studies. For the first time this new framework may allow quantification of potential species loss resulting from flow change, and may offer an improved understanding of aquatic life risk variability due to geographic location, stream size and local scale. 

In order to calculate river segment-level richness change, elfgen is first used to produce relations between stream flow and species richness at the HUC 8 scale (See plot below). This is achieved using long term datasets for both ecological and hydrologic data. Ecological data (Fish species richness) is sourced from the VAHydro-EDAS dataset. Hydrologic data (Average Annual Flow) is sourced from the National Hydrography Dataset Plus. The Richness Change values presented in the 6.1. Stats Comparison Table are derived from this flow-ecology relation.


```{r GrabELFPlot, include=FALSE, echo=FALSE}
# Need to have a switch based on draiange area with text such as:
# Ecological Limit Functions are not available for this location because the drainage area exceeds 800 square miles, which is beyond the applicable range of current mean flow based ecological limit functions.


run_container <- om_get_prop(site, rseg.model$pid, entity_type = 'dh_properties',runid.list[1])
fig_path = FALSE
elfgen_EDAS_huc8 <- om_get_prop(site, run_container$pid, entity_type = 'dh_properties','elfgen_EDAS_huc8')
if (!is.logical(elfgen_EDAS_huc8)) {
  fig.elfgen <- om_get_prop(site, elfgen_EDAS_huc8$pid, entity_type = 'dh_properties','fig.elfgen')
  fig_path <- fig.elfgen$propcode
}
``` 

```{r elfPlot, echo=FALSE, results = "asis"}
if (!is.logical(fig_path)) {
  cat(paste0("![](",fig_path,")"),"\n")

} else {
  cat(paste0("*No elfgen plot available for this model*"))
}
```


## Habitat (If Applicable):
