library('sqldf')
readClipboard()
A <- read.csv("C:\\Users\\rnv55934\\Downloads\\VAHydro_Phase4_Facility_Mapping.xlsx")
View(A)
readClipboard()
A <- read.csv("C:\\Users\\rnv55934\\Documents\\Docs\\Misc\\Tasks Misc\\VAHydro_Phase4_Facility_Mapping.csv")
View(A)
readClipboard()
readClipboard()
#rest_uname = FALSE
#rest_pw = FALSE
basepath ='/var/www/R'
source(paste0(basepath,'/auth.private'))
source(paste0(basepath,'/config.R'))
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
library("hydrotools")
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
startdate <-"1982-01-01"
enddate <-"2022-11-21"
#load in foundaiton data from Annual Map Exports EXPANDED view which includes organizations and permits
exp_url <- paste0(site,"ows-awrr-map-export-expanded/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=",startdate,"&tstime%5Bmax%5D=",enddate,"&bundle%5B0%5D=well&bundle%5B1%5D=intake&hydroid=")
exp_url
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
Exp <- ds$auth_read(exp_url, content_type = "text/csv", delim = ",")
rest_uname = FALSE
rest_pw = FALSE
#rest_uname = FALSE
#rest_pw = FALSE
basepath ='/var/www/R'
source(paste0(basepath,'/auth.private'))
source(paste0(basepath,'/config.R'))
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
#####################
#from AWRR
#load in MGY from Annual Map Exports view
tsdef_url <- paste0(site,"ows-awrr-map-export/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=1982-01-01&tstime%5Bmax%5D=",eyear,"-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake")
#####################
#from AWRR
eyear<-2021
#load in MGY from Annual Map Exports view
tsdef_url <- paste0(site,"ows-awrr-map-export/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=1982-01-01&tstime%5Bmax%5D=",eyear,"-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake")
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
library("RCurl")
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
library('stringr')
#load in MGY from Annual Map Exports view
tsdef_url <- paste0(site,"ows-awrr-map-export/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=1982-01-01&tstime%5Bmax%5D=",eyear,"-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake")
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
library("kableExtra")
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
library('httr')
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
library('tidyverse') #loads in tidyr, dplyr, ggplot2, etc
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
A <- read.csv("C:\\Users\\rnv55934\\Documents\\Docs\\Misc\\Tasks Misc\\VAHydro_Phase4_Facility_Mapping.csv")
B <- read.csv("U:\\OWS\\foundation_datasets\\awrr\\2022\\mp_all_mgy_2017-2021.csv") #join hydroid to use type, derive 5yr avg
View(A)
View(B)
names(a)
names(A)
names(B)
AB <- sqldf('SELECT A.*, B."Source.Type"
FROM A
LEFT JOIN B
ON A.VAHYDRO_HYDROID = B.Facility_hydroid')
AB <- sqldf('SELECT A.*, B."Source.Type"
FROM A a
LEFT JOIN B b
ON A.VAHYDRO_HYDROID = B.Facility_hydroid')
AB <- sqldf('SELECT a.*, b."Source.Type"
FROM A a
LEFT JOIN B b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
BB <- sqldf('SELECT Facility_hydroid, "Use.Type" as Use_Type FROM B')
AB <- sqldf('SELECT a.*, b."Source.Type"
FROM A a
LEFT JOIN BB b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
AB <- sqldf('SELECT a.*, b.Use_Type
FROM A a
LEFT JOIN BB b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
AB <- sqldf('SELECT a.*, b.Use_Type
FROM A a
Inner JOIN BB b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
A <- read.csv("C:\\Users\\rnv55934\\Documents\\Docs\\Misc\\Tasks Misc\\VAHydro_Phase4_Facility_Mapping.csv")
B <- read.csv("U:\\OWS\\foundation_datasets\\awrr\\2022\\mp_all_mgy_2017-2021.csv") #join hydroid to use type, derive 5yr avg
BB <- sqldf('SELECT Facility_hydroid, "Use.Type" as Use_Type FROM B')
AB <- sqldf('SELECT a.*, b.Use_Type
FROM A a
LEFT JOIN BB b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
View(AB)
View(A)
BB <- sqldf('SELECT Facility_hydroid, "Use.Type" as Use_Type FROM B
Group By Facility_hydroid')
AB <- sqldf('SELECT a.*, b.Use_Type
FROM A a
LEFT JOIN BB b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
readClipboard()
D <- read.csv("C:\\Users\\rnv55934\\Downloads\\ows_annual_report_map_exports-expanded (1).csv")
Exp <- ds$auth_read(exp_url, content_type = "text/csv", delim = ",")
library('sqldf')
library("hydrotools")
A <- read.csv("C:\\Users\\rnv55934\\Documents\\Docs\\Misc\\Tasks Misc\\VAHydro_Phase4_Facility_Mapping.csv")
B <- read.csv("U:\\OWS\\foundation_datasets\\awrr\\2022\\mp_all_mgy_2017-2021.csv") #join hydroid to use type, derive 5yr avg
C <- read.csv("U:\\OWS\\foundation_datasets\\awrr\\2022\\ows_permit_list.csv") #join hydroid to permit number, dont use owner here
D <- read.csv("C:\\Users\\rnv55934\\Downloads\\ows_annual_report_map_exports-expanded (1).csv") # expanded map exports which includes owner and permit
basepath ='/var/www/R'
source(paste0(basepath,'/auth.private'))
source(paste0(basepath,'/config.R'))
ds <- RomDataSource$new("http://deq1.bse.vt.edu/d.dh", rest_uname)
ds$get_token(rest_pw)
startdate <-"1982-01-01"
enddate <-"2022-11-21"
#load in foundation data from Annual Map Exports EXPANDED view which includes organizations and permits
exp_url <- paste0(site,"ows-awrr-map-export-expanded/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=",startdate,"&tstime%5Bmax%5D=",enddate,"&bundle%5B0%5D=well&bundle%5B1%5D=intake&hydroid=")
Exp <- ds$auth_read(exp_url, content_type = "text/csv", delim = ",")
exp_url
#load in MGY from Annual Map Exports view
tsdef_url <- paste0(site,"ows-awrr-map-export/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=1982-01-01&tstime%5Bmax%5D=",eyear,"-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake")
##################### EXAMPLE ###################
#from AWRR
eyear<-2021
#load in MGY from Annual Map Exports view
tsdef_url <- paste0(site,"ows-awrr-map-export/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=1982-01-01&tstime%5Bmax%5D=",eyear,"-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake")
tsdef_url
exp_url
#NOTE: this takes 5-8 minutes (grab a snack; stay hydrated)
multi_yr_data <- ds$auth_read(tsdef_url, content_type = "text/csv", delim = ",")
names(D)
#Group by facility
BB <- sqldf('SELECT Facility_hydroid, "Use.Type" as Use_Type, sum(X2017) as X2017, sum(X2018) as X2018, sum(X2019) as X2019, sum(X2020) as X2020, sum(X2021) as X2021
FROM B
Group By Facility_hydroid')
DD <- sqldf('SELECT "Facility.ID" as Facility_hydroid, "Permit.ID" as PermitID, Owner
FROM D
Group By "Facility.ID" ')
#calculate Five Year Avg
five_yr_avg <- round((rowMeans(BB[3:7], na.rm = FALSE, dims = 1)),2)
ut_5ya <- cbind(cat_table, five_yr_avg)
ut_5ya <- cbind(BB, five_yr_avg)
head(ut_5ya)
#calculate Five Year Avg
five_yr_avg <- round((rowMeans(BB[3:7], na.rm = TRUE, dims = 1)),2)
ut_5ya <- cbind(BB, five_yr_avg)
head(ut_5ya)
#join A to Use Type and Five Year Avg
A_ut_5ya <- sqldf('SELECT a.*, b.Use_Type, b.five_yr_avg
FROM A a
LEFT JOIN ut_5ya b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
head(A_ut_5ya)
#join A to Permit and Owner
A_Prmt_Ownr <- sqldf('SELECT a.*, b.PermitID, b.Owner
FROM A_ut_5ya a
LEFT JOIN DD b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
head(DD)
View(A_Prmt_Ownr)
#check whether any hydroids were unmatched
A_not_BB <- sqldf('select * from A where Facility_hydroid NOT IN
(SELECT Facility_hydroid from BB)')
#check whether any hydroids were unmatched
A_not_BB <- sqldf('select * from A where Facility_hydroid NOT IN
(select VAHYDRO_HYDROID from BB)')
#check whether any hydroids were unmatched
A_not_BB <- sqldf('select * from A where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from BB)')
View(A_not_BB)
#check whether any hydroids were unmatched
A_not_BB <- sqldf('select * from A_Prmt_Ownr where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from BB)')
A_not_DD <- sqldf('select * from A_Prmt_Ownr where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD)')
View(A_not_DD)
A_not_BD <-  sqldf('select * from A_Prmt_Ownr where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD) AND VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD) ')
View(A_not_BD)
B_not_D <- sqldf('select * from BB where Facility_hydroid NOT IN
(select Facility_hydroid from DD)')
D_not_B <- sqldf('select * from DD where Facility_hydroid NOT IN
(select Facility_hydroid from BB)')
View(D_not_B)
View(B_not_D)
PermitList <- ds$auth_read(permit_url, content_type = "text/csv", delim = ",")
#load in OWS Permit List
permit_url <-" https://deq1.bse.vt.edu/d.dh/ows-permit-list?fstatus=All&modified=&startdate_op=%3D&startdate%5Bvalue%5D=&startdate%5Bmin%5D=&startdate%5Bmax%5D=&permit_id_value_op=%3D&permit_id_value=&dh_link_admin_reg_issuer_target_id_op=in&dh_link_admin_reg_issuer_target_id%5B%5D=65668&dh_link_admin_reg_issuer_target_id%5B%5D=91200&sort_by=enddate&sort_order=ASC"
PermitList <- ds$auth_read(permit_url, content_type = "text/csv", delim = ",")
#load in OWS Permit List
permit_url <-"https://deq1.bse.vt.edu/d.dh/ows-permit-list?fstatus=All&modified=&startdate_op=%3D&startdate%5Bvalue%5D=&startdate%5Bmin%5D=&startdate%5Bmax%5D=&permit_id_value_op=%3D&permit_id_value=&dh_link_admin_reg_issuer_target_id_op=in&dh_link_admin_reg_issuer_target_id%5B%5D=65668&dh_link_admin_reg_issuer_target_id%5B%5D=91200&sort_by=enddate&sort_order=ASC"
PermitList <- ds$auth_read(permit_url, content_type = "text/csv", delim = ",")
#load in foundation data from Annual Map Exports EXPANDED view which includes organizations and permits
exp_url <- paste0(site,"ows-awrr-map-export-expanded/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=",startdate,"&tstime%5Bmax%5D=",enddate,"&bundle%5B0%5D=well&bundle%5B1%5D=intake&hydroid=")
Exp <- ds$auth_read(exp_url, content_type = "text/csv", delim = ",")
readClipboard()
C <- read.csv("C:\\Users\\rnv55934\\Downloads\\ows_permit_list.csv") #includes permit number and owner
names(C)
CC <- ('SELECT "VA.Hydro.Facility.ID" as Facility_hydroid, Owner, "Permit.ID" as PermitID
FROM C
Group By "VA.Hydro.Facility.ID" ')
CC <- sqldf('SELECT "VA.Hydro.Facility.ID" as Facility_hydroid, Owner, "Permit.ID" as PermitID
FROM C
Group By "VA.Hydro.Facility.ID" ')
#join A to Permit and Owner
A_Prmt_Ownr1 <- sqldf('SELECT a.*, b.Owner, b.PermitID
FROM A_ut_5ya a
LEFT JOIN CC b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
#check whether any hydroids were unmatched
A_not_BB <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from BB)')
A_not_DD <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD)')
A_not_BD <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD) AND VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD) ')
B_not_C <- sqldf('select * from BB where Facility_hydroid NOT IN
(select Facility_hydroid from CC)')
C_not_B <- sqldf('select * from CC where Facility_hydroid NOT IN
(select Facility_hydroid from BB)')
View(C_not_B)
whichmatter <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID IN
(select Facility_hydroid from C_not_B)')
export_path
#when ready
export_path <- "C:/Users/rnv55934/Documents/Docs/Misc/Tasks Misc"
write.csv(A_Prmt_Ownr1,export_path,row.names = F)
#when ready
export_path <- "C:/Users/rnv55934/Documents/Docs/Misc/Tasks Misc/"
write.csv(A_Prmt_Ownr1,paste0(export_path,"A_Prmt_Ownr1.csv"),row.names = F)
View(C)
View(ut_5ya)
#load in OWS Permit List
permit_url <-"https://deq1.bse.vt.edu/d.dh/ows-awrr-map-export-expanded/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=2020-01-01&tstime%5Bmax%5D=2020-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake&hydroid="#"https://deq1.bse.vt.edu/d.dh/ows-permit-list?fstatus=All&modified=&startdate_op=%3D&startdate%5Bvalue%5D=&startdate%5Bmin%5D=&startdate%5Bmax%5D=&permit_id_value_op=%3D&permit_id_value=&dh_link_admin_reg_issuer_target_id_op=in&dh_link_admin_reg_issuer_target_id%5B%5D=65668&dh_link_admin_reg_issuer_target_id%5B%5D=91200&sort_by=enddate&sort_order=ASC"
PermitList <- ds$auth_read(permit_url, content_type = "text/csv", delim = ",")
site
#load in OWS Permit List
permit_url <-paste0(site,"ows-awrr-map-export-expanded/wd_mgy?ftype_op=%3D&ftype=&tstime_op=between&tstime%5Bvalue%5D=&tstime%5Bmin%5D=2020-01-01&tstime%5Bmax%5D=2020-12-31&bundle%5B0%5D=well&bundle%5B1%5D=intake&hydroid=")#"https://deq1.bse.vt.edu/d.dh/ows-permit-list?fstatus=All&modified=&startdate_op=%3D&startdate%5Bvalue%5D=&startdate%5Bmin%5D=&startdate%5Bmax%5D=&permit_id_value_op=%3D&permit_id_value=&dh_link_admin_reg_issuer_target_id_op=in&dh_link_admin_reg_issuer_target_id%5B%5D=65668&dh_link_admin_reg_issuer_target_id%5B%5D=91200&sort_by=enddate&sort_order=ASC"
PermitList <- ds$auth_read(permit_url, content_type = "text/csv", delim = ",")
#calculate Five Year Avg
five_yr_avg <- round((rowMeans(BB[3:7], na.rm = TRUE, dims = 1)),2)
ut_5ya <- cbind(BB, five_yr_avg)
#join A to Use Type and Five Year Avg
A_ut_5ya <- sqldf('SELECT a.*, b.Use_Type, b.five_yr_avg
FROM A a
LEFT JOIN ut_5ya b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
#join A to Permit and Owner
A_Prmt_Ownr1 <- sqldf('SELECT a.*, b.Owner, b.PermitID
FROM A_ut_5ya a
LEFT JOIN CC b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
#join A to Permit and Owner
A_Prmt_Ownr2 <- sqldf('SELECT a.*, b.PermitID, b.Owner
FROM A_ut_5ya a
LEFT JOIN DD b
ON a.VAHYDRO_HYDROID = b.Facility_hydroid')
#check whether any hydroids were unmatched
A_not_BB <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from BB)')
A_not_DD <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD)')
A_not_BD <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD) AND VAHYDRO_HYDROID NOT IN
(select Facility_hydroid from DD) ')
#B_not_C <- sqldf('select * from BB where Facility_hydroid NOT IN
#                 (select Facility_hydroid from CC)')
C_not_B <- sqldf('select * from CC where Facility_hydroid NOT IN
(select Facility_hydroid from BB)')
whichmatter <- sqldf('select * from A_Prmt_Ownr1 where VAHYDRO_HYDROID IN
(select Facility_hydroid from C_not_B)')
B_not_D <- sqldf('select * from BB where Facility_hydroid NOT IN
(select Facility_hydroid from DD)')
D_not_B <- sqldf('select * from DD where Facility_hydroid NOT IN
(select Facility_hydroid from BB)')
#calculate Five Year Avg
five_yr_avg <- round((rowMeans(BB[3:7], na.rm = TRUE, dims = 1)),2)
ut_5ya <- cbind(BB, five_yr_avg)
five_yr_avg <- round((rowMeans(BB[3:7], na.rm = FALSE, dims = 1)),2)
ut_5ya <- cbind(BB, five_yr_avg)
#calculate Five Year Avg
five_yr_avg <- round((rowMeans(BB[3:7], na.rm = TRUE, dims = 1)),2)
ut_5ya <- cbind(BB, five_yr_avg)
