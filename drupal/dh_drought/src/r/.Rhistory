rm(list = ls())  #clear variables
library(dataRetrieval) #https://cran.r-project.org/web/packages/dataRetrieval/dataRetrieval.pdf
library(lubridate) #required for year()
library(sqldf) #required for SQL queries
library(openxlsx) #required  for exporting data to excel file, each well as separate sheet
# library(httr)
basepath <- "/var/www/R/"
source(paste(basepath,"config.local.private",sep = '/'))
# load libraries
source(paste(hydro_tools,"VAHydro-2.0/rest_functions.R", sep = "/"));
source(paste(basepath,"auth.private",sep = '/'))
token <- rest_token (base_url, token, rest_uname = rest_uname, rest_pw = rest_pw) #token needed for REST
site <- base_url
#USED TO EXPORT TABLES AS INDIVIDUAL CSVS, AND EXCEL FILE WITH MULTIPLE SHEETS
export_path <- 'C:/Users/jklei/Desktop/Potomac Monitoring Wells/exports/'
#Pull in list of all Potomac Monitoring Well dH Features
URL <- paste(site,"potomac-monitoring-wells-export", sep = "/");
well_list <- read.table(URL,header = TRUE, sep = ",")
hydrocodes <- well_list$hydrocode
well_names <- well_list$Feature.Name
#INITIATE LIST OF ALL WELLS DATA
annual_summary_list <- list()
j <-1
print(paste("PROCESSING WELL: ",j," OF ",length(hydrocodes),sep=''))
siteNumber = unlist(strsplit(toString(hydrocodes[j]), split='_', fixed=TRUE))[2]
well_code <- substr(well_names[j], 22, nchar(well_names[j]))
print(paste("USGS siteNumber: ", siteNumber, sep=''))
welldata <- whatNWISdata(siteNumber = siteNumber)
#Parameter code '72019' = Depth to water level, feet below land surface (ft) https://help.waterdata.usgs.gov/code/parameter_cd_nm_query?parm_nm_cd=%25level%25&fmt=html
#Data type 'dv' = Daily Values
#RETRIEVE DATE WELL BEGAN RECORDING DAILY DEPTH TO WATER LEVEL
gwl_param <-          paste("SELECT begin_date
FROM welldata
WHERE parm_cd == 72019 AND data_type_cd == 'dv'
ORDER BY begin_date ASC
LIMIT 1",sep="")
begin_date <- sqldf(gwl_param)$begin_date
print(paste("Historic Record begining ",begin_date,sep=""))
#RETREIEVE DATA FROM NWIS
url <- paste("https://waterdata.usgs.gov/nwis/dv?cb_72019=on&format=rdb_meas&site_no=",siteNumber,"&referred_module=sw&period=&begin_date=",begin_date,"&end_date=",sep="")
print(paste("Retrieving Data from NWIS using:",url))
data <- read.table(url,header = TRUE, sep = "\t")
View(data)
